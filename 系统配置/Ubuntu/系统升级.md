# Ubuntu 20.04 升级至 22.04 及 ROS 2 迁移技术笔记

## 1. 核心背景与故障回溯

* **目标**：从 Ubuntu 20.04 (Focal) 升级到 22.04 (Jammy)。
* **关键变更**：
* **Firefox**：从 `.deb` 切换为强制 `Snap` 格式。
* **Python**：从 3.8 升级至 3.10。
* **ROS 2**：从 Foxy (对应 20.04) 迁移至 Humble (对应 22.04)。


* **已解决故障**：
* 升级脚本因 Snap 网络连接极慢（50个月）而中断。
* `appstreamcli` 符号查找错误（底层 C++ 库版本冲突）。
* `usb-creator-gtk` 依赖报错导致 `dpkg` 锁死。
* `.bashrc` 残留无效的 Foxy 路径。



---

## 2. 关键修复步骤（复盘）

### A. 强制解除锁定与修复环境

当升级意外中断，首要任务是释放 `dpkg` 锁并修复损坏的依赖：

```bash
# 1. 强行终止相关进程并清理锁文件
sudo pkill -9 snap && sudo pkill -9 apt
sudo rm /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock

# 2. 移除导致报错的非核心包（如 usb-creator-gtk）
sudo dpkg --remove --force-remove-reinstreq usb-creator-gtk

# 3. 修复受损依赖
sudo dpkg --configure -a
sudo apt install -f

```

### B. 解决 AppStream 库冲突

针对 `symbol lookup error`，采用清理缓存并强制对齐版本的方法：

```bash
# 暂时禁用 appstream 触发器并清理旧数据
sudo mv /etc/apt/apt.conf.d/50appstream /etc/apt/apt.conf.d/50appstream.bak
sudo rm -rf /var/cache/app-info && sudo mkdir -p /var/cache/app-info

# 重新安装核心库
sudo apt install --reinstall appstream libappstream4

```

### C. ROS 2 开发环境迁移

因 Ubuntu 版本更新，必须同步升级 ROS 版本：

1. **清理旧版**：卸载 `ros-foxy-*`。
2. **清理配置**：在 `~/.bashrc` 中删除 `source /opt/ros/foxy/setup.bash`。
3. **安装新版**：配置 ROS 2 Humble 镜像源并安装 `ros-humble-desktop`。
4. **环境对齐**：在 `~/.bashrc` 添加 `source /opt/ros/humble/setup.bash`。

---

## 3. 升级成功验证标准

### 操作系统层

* **版本确认**：`lsb_release -a` 应显示 `Ubuntu 22.04.x LTS`。
* **内核确认**：`uname -r` 应为 `5.15.x` 或以上。
* **Python版本**：`python3 --version` 应为 `Python 3.10.x`。

### 软件包管理器

* **更新测试**：`sudo apt update` 无符号报错，无依赖冲突提示。
* **健康状态**：`appstreamcli --version` 正常返回版本号。

### ROS 2 开发层

* **发行版确认**：`printenv ROS_DISTRO` 结果为 `humble`。
* **通讯测试**：运行 `ros2 run demo_nodes_cpp talker` 与 `listener` 能正常发送/接收数据。

---

## 4. 后续维护建议

1. **源码重编**：如果您之前有 C++ 编写的 ROS 工作空间，请务必删除 `build/`、`install/` 和 `log/` 目录，并使用 `colcon build` 在新环境下重新编译。
2. **Firefox 加速**：如果 Snap 版下载依然缓慢，建议使用 `Mozilla Team PPA` 安装 `.deb` 版本。
3. **常规清理**：执行 `sudo apt autoremove` 移除升级后残留的 20.04 旧包。

---