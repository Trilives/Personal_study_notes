#  EasyTier 组网故障排查笔记

### 1. 故障现象

- **状态**：Docker 容器状态显示为 `Restarting (x) ...`，无法正常启动。
    
- **原因**：EasyTier 命令行参数解析失败。
    
    - **核心诱因**：在 `command` 中使用了无法识别或格式错误的参数（如 `--subnet` 在某些版本或特定配置下无法直接识别，或者与 `dhcp` 模式冲突）。
        
    - **次要诱因**：`/etc/easytier` 目录下已存在的配置文件与 `command` 参数冲突。
        

### 2. 解决方案

- **简化参数**：移除不必要的参数，优先确保基础组网成功，推荐使用 `--dhcp` 模式自动分配虚拟 IP。
    
- **环境变量**：确保映射了 `/dev/net/tun` 和宿主机的机器码。
    
- **清理环境**：若修改后仍重启，需清理旧的容器实例。
    

---

### 3. 推荐的 Docker Compose 配置

这是经过修正并验证的配置文件，使用公共节点进行中转：

YAML

```
version: '3.8'

services:
  easytier:
    image: easytier/easytier:latest
    container_name: easytier
    hostname: work_hp
    restart: unless-stopped
    network_mode: host
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=Asia/Shanghai
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /etc/easytier:/root
      - /etc/machine-id:/etc/machine-id:ro # 映射宿主机机器码防止ID冲突
    # 核心配置说明：
    # -n: 网络名称
    # -s: 网络密钥
    # --dhcp: 开启自动分配虚拟IP
    # -p: 指定公共对等节点地址
    command: >
      -n "worknet_trlives" 
      -s "12345687" 
      --dhcp 
      -p tcp://public.easytier.cn:11010

  watchtower: # 自动更新 EasyTier
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600 --cleanup --label-enable
```

---

### 4. 故障检查命令（避坑指南）

如果配置后仍有问题，按此顺序排查：

1. **看日志**：`docker logs easytier`（如果提示 `invalid argument`，说明参数写错了）。
    
2. **查状态**：`docker exec -it easytier easytier-cli peer`（查看是否看到其他节点）。
    
3. **查 IP**：`ip addr show dev et_...`（查看宿主机是否多了一个虚拟网卡）。
    