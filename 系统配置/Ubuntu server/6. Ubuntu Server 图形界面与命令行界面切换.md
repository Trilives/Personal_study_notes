# Ubuntu Server 与 Desktop 环境深度切换及开发配置笔记

### 1. 系统版本特性与本质区别

Ubuntu 桌面版与服务器版使用相同的 Linux 内核与基础软件仓库，其差异主要体现在元软件包（Meta-packages）的预置：

* **Ubuntu Desktop**：预装 GNOME 图形环境、NetworkManager、各类多媒体驱动以及 LibreOffice 等办公应用。
* **Ubuntu Server**：预装 OpenSSH、Netplan、LVM 逻辑卷支持，极度精简，专为后台服务设计。
* **核心逻辑**：在服务器版上叠加桌面组件，可以获得服务器的底层稳定性（如 Netplan 管理）与桌面的操作便利。

### 2. 核心操作：环境切换与模式锁定

#### 步骤一：安装桌面环境组件

在 Server 终端执行更新并安装桌面。若要保持系统轻量化，建议使用最小化安装：

```bash
sudo apt update
sudo apt install --no-install-recommends ubuntu-desktop

```

#### 步骤二：锁定系统启动目标（关键设置）

为了确保系统长期处于服务器模式，不被图形界面占用内存，需显式修改 systemd 的启动目标：

```bash
# 设为默认命令行模式（服务器模式）
sudo systemctl set-default multi-user.target

```

此后，开机将停留在 TTY 登录界面，不会自动启动图形环境。

#### 步骤三：按需进入/退出桌面

* **临时启动桌面**：`sudo systemctl start gdm3`
* **任务完成退出**：`sudo systemctl stop gdm3` 或直接重启系统。

### 3. 中文环境与输入法配置（安装与卸载）

#### 解决乱码问题

Server 版缺少中文字体，需先安装字体库并生成字符集：

```bash
# 安装文泉驿字体库
sudo apt install fonts-wqy-microhei fonts-wqy-zenhei
# 生成中文语言包
sudo locale-gen zh_CN.UTF-8

```

#### 安装中文输入法（Fcitx5 框架）

Fcitx5 是目前 Linux 下最稳定且支持代理环境的输入法框架。

1. **安装软件包**：
```bash
sudo apt install fcitx5 fcitx5-chinese-addons

```


2. **配置环境变量**：在 `~/.bashrc` 或 `~/.profile` 中添加：
```bash
export INPUT_METHOD=fcitx
export QT_IM_MODULE=fcitx
export GTK_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx

```


3. **启用输入法**：进入桌面后，在“语言支持”中将输入法框架选为 Fcitx5，并添加“Pinyin”输入法。

#### 卸载中文输入法

```bash
sudo apt purge fcitx5*
sudo apt autoremove

```

### 4. 开发工具安装与卸载（绕过 Snap 的 APT 方案）

#### Visual Studio Code

1. **安装**：
```bash
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
sudo sh -c 'echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
sudo apt update && sudo apt install code

```


2. **卸载**：
```bash
sudo apt purge code
sudo rm /etc/apt/sources.list.d/vscode.list

```



#### Google Chrome

1. **安装**：
```bash
wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo apt install ./google-chrome-stable_current_amd64.deb

```


2. **卸载**：
```bash
sudo apt purge google-chrome-stable

```



### 5. 代理环境适配：让 GUI 应用使用终端代理

若已在终端配置了 `http_proxy` 环境变量，需确保 GUI 应用正确继承。

* **VS Code 代理设置**：
VS Code 启动时通常会自动检测环境变量。若失败，需在设置中搜索 `Proxy`，将 `Http: Proxy` 手动填入 `http://127.0.0.1:端口`。
* **Chrome 强制代理启动**：
Chrome 常忽略系统代理变量，建议通过命令行带参数启动：
```bash
google-chrome-stable --proxy-server="http://127.0.0.1:端口"

```



### 6. 服务器长期维护建议

* **远程管理**：确保 `openssh-server` 处于运行状态，通过 SSH 密钥进行登录，关闭密码登录以增强安全性。
* **Web 管理面板**：安装 `cockpit`，通过浏览器 `https://IP:9090` 监控系统资源。
* **资源监控**：定期在命令行使用 `htop` 查看内存分配，确认关闭桌面（gdm3）后内存是否成功释放。

### 7. 总结流程

1. **当前阶段**：安装桌面环境、中文输入法、VS Code 与 Chrome。
2. **临时办公**：通过 `start gdm3` 进入桌面，利用终端代理参数启动工具。
3. **清理阶段**：办公结束后卸载 Chrome、VS Code 及输入法。
4. **长期运行**：系统通过 `multi-user.target` 保持在命令行模式，作为高性能服务器持续运行。