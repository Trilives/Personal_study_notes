# Ubuntu Server 自动联网配置笔记

## 1. 问题背景

Ubuntu Server 默认使用 Netplan 管理网络。在某些环境下（如使用了 Cloud-init 或虚拟机克隆），系统可能不会在启动时自动触发 DHCP 请求，导致必须手动执行 `sudo dhclient` 才能上网。

---

## 2. 方案对比：Netplan 配置 vs. dhclient 脚本

|**特性**|**方案 A：Netplan 规范配置 (推荐)**|**方案 B：dhclient 开机指令 (应急)**|
|---|---|---|
|**原理**|修改系统原生网络管理器配置|暴力在系统启动后补丁式运行命令|
|**优点**|**符合系统逻辑**、支持 IPv4/IPv6 双栈、管理方便、延迟低。|**成功率 100%**、不担心被其他网络软件覆盖。|
|**缺点**|容易受 Cloud-init 干扰导致重启失效。|属于“打补丁”，不符合 Linux 网络管理规范。|
|**适用场景**|长期稳定使用的服务器。|各种配置都尝试了但重启依然没网的情况。|

---

## 3. 复现步骤

### 步骤一：确认网卡名称（环境检查）

在配置前，必须确认物理网卡名称。

Bash

```
ip link
# 示例输出中找到类似 enp3s0 的名称
```

### 步骤二：方案 A - 修正 Netplan（正规做法）

1. **禁用 Cloud-init 网络接管（防止配置被重置）**：
    
    Bash
    
    ```
    echo "network: {config: disabled}" | sudo tee /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    ```
    
2. 编写网络配置文件：
    
    编辑 /etc/netplan/50-cloud-init.yaml（或该目录下其他 .yaml）：
    
    Bash
    
    ```
    sudo nano /etc/netplan/50-cloud-init.yaml
    ```
    
    **复制以下内容（注意缩进，网卡名改自己的）：**
    
    YAML
    
    ```
    network:
      version: 2
      renderer: networkd
      ethernets:
        enp3s0:         # 替换为你的网卡名
          dhcp4: true   # 开启 IPv4
          dhcp6: true   # 开启 IPv6
          accept-ra: true
    ```
    
3. **应用配置**：
    
    Bash
    
    ```
    sudo netplan apply
    ```
    

---

### 步骤三：方案 B - 强制开机指令（保底做法）

如果方案 A 重启后依然失效，请使用此方案强制开机运行 `dhclient`。

1. **创建自动化脚本**：
    
    Bash
    
    ```
    sudo nano /usr/local/bin/fix-net.sh
    ```
    
    **写入以下内容：**
    
    Bash
    
    ```
    #!/bin/bash
    # 等待 5 秒确保硬件就绪
    sleep 5
    /usr/sbin/dhclient enp3s0
    ```
    
2. **赋予执行权限**：
    
    Bash
    
    ```
    sudo chmod +x /usr/local/bin/fix-net.sh
    ```
    
3. **设置开机启动 (Crontab 方式)**：
    
    Bash
    
    ```
    sudo crontab -e
    ```
    
    在文件最末尾添加一行：
    
    Plaintext
    
    ```
    @reboot /usr/local/bin/fix-net.sh
    ```
    

---

## 4. 验证命令

重启后执行以下命令确认状态：

- **检查 IP 获取情况**：`ip addr show enp3s0`
    
- **检查 IPv4 连通性**：`ping -4 google.com`
    
- **检查 IPv6 连通性**：`ping -6 google.com`
    
- **检查网络服务状态**：`systemctl status systemd-networkd`
    

---

笔记维护者： trlives & Gemini

最后更新： 2026-01-12