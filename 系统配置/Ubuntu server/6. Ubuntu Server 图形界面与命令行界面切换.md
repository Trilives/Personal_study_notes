### Ubuntu Server 图形界面与命令行界面切换全手册

本手册针对 Ubuntu Server 环境下短期启用图形化操作（如连接物理显示器使用 VS Code）的需求，提供了从安装、运行模式管理到后期深度清理的完整技术细节。

---

### 第一部分：环境构建与极简桌面安装

在服务器环境下，应避免安装包含大量办公套件和多媒体残留的 `ubuntu-desktop` 完整版。推荐使用 XFCE 桌面环境，其结构简单且对系统服务的依赖程度极低。

1. **更新软件包索引**
在进行任何安装前，务必同步软件源：
`sudo apt update`
2. **安装 XFCE4 及核心组件**
使用以下命令安装最基础的桌面组件：
`sudo apt install xfce4 xfce4-goodies xorg`
注：`xorg` 是显示服务器的核心，`xfce4-goodies` 提供了必要的文件管理器和系统设置工具。
3. **安装 VS Code**
在服务器上，推荐通过 Snap 方式安装，这样可以有效隔离图形程序的依赖：
`sudo snap install code --classic`

---

### 第二部分：运行模式的灵活切换

Ubuntu 使用 Systemd 管理运行级别（Target）。了解如何控制默认启动行为是保持服务器纯净的关键。

#### 1. 设置默认启动目标

* **保持纯净命令行启动（推荐）：**
即便安装了 GUI，也应让服务器开机默认停留在黑窗口界面，以节省 CPU 和内存资源。
`sudo systemctl set-default multi-user.target`
* **临时启动图形界面：**
当你连接好显示器并登录后，输入以下命令手动载入桌面：
`startx`
退出时，只需在 XFCE 菜单中点击“注销 (Log Out)”，系统将自动切断图形会话并返回原有的命令行控制台。
* **设置为默认进入图形登录界面：**
如果你希望这几天开机直接看到登录窗口：
`sudo systemctl set-default graphical.target`

#### 2. 利用虚拟控制台 (TTY) 实时切换

即使在运行图形界面时，Linux 也提供了多个并行的终端通道：

* **进入 GUI 通道：** 通常在 `Ctrl + Alt + F1` 或 `F2`。
* **进入纯命令行通道：** 尝试 `Ctrl + Alt + F3` 到 `F6`。这允许你在图形界面死机或卡顿时，切换到后台命令行进行进程终止或系统维护。

---

### 第三部分：硬件适配建议

* **显卡驱动：** 如果你使用的是 NVIDIA 显卡，XFCE 可能会使用开源的 `nouveau` 驱动。若运行 VS Code 感觉渲染卡顿，可能需要安装私有驱动，但这会增加后期清理的复杂度。若只是短期使用，建议维持默认驱动。
* **显示器连接：**
部分 Ubuntu Server 默认不开启显卡的电缆检测。如果在接入显示器后无信号，建议在执行 `startx` 前确保显示器已开启并切换至正确的输入源。

---

### 第四部分：后期深度清理与恢复

当短期任务结束，需要将服务器恢复至最初的纯净状态时，必须遵循严格的卸载步骤，以移除数以百计的依赖包。

1. **还原启动目标**
首先确保系统不再尝试进入图形模式：
`sudo systemctl set-default multi-user.target`
2. **卸载图形应用程序**
`sudo snap remove code`
3. **卸载桌面环境及关联包**
使用 `purge` 参数不仅删除程序，还删除相关的全局配置文件：
`sudo apt purge xfce4 xfce4-goodies x11-common xserver-xorg`
4. **核心清理操作（极重要）**
安装 GUI 时会引入大量的库文件（如字体、图形库、通讯协议）。以下命令将扫描系统中所有不再被任何手动安装软件所依赖的包并将其删除：
`sudo apt autoremove --purge`
`sudo apt clean`
5. **验证清理结果**
执行以下命令查看是否还有图形相关的进程在后台运行：
`ps aux | grep xorg`
`free -h`
通过查看内存占用情况，确认系统已恢复至预期的低负载状态。

---

### 总结建议

在物理操作期间，建议优先使用 `multi-user.target` 配合 `startx` 的方案。这种方式下，图形界面仅作为一个普通的应用程序运行，不会修改系统的底层启动链，在拔掉显示器后，系统状态与安装 GUI 前几乎无异。