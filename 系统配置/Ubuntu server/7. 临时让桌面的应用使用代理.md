# Ubuntu 22.04 代理环境配置

## 一、核心配置

### 1. 代理管理函数（`~/.bashrc`）

```bash
# 代理管理函数
proxy_on() {
    export http_proxy="http://127.0.0.1:7890"
    export https_proxy="http://127.0.0.1:7890"
    export all_proxy="socks5h://127.0.0.1:7891"
    
    export HTTP_PROXY="$http_proxy"
    export HTTPS_PROXY="$https_proxy"
    export ALL_PROXY="$all_proxy"
    
    export no_proxy="localhost,127.0.0.1,::1"
    export NO_PROXY="$no_proxy"
    
    echo -e "\033[32m[✔] 代理已开启 (HTTP:7890, SOCKS5:7891)\033[0m"
}

proxy_off() {
    unset http_proxy https_proxy all_proxy \
          HTTP_PROXY HTTPS_PROXY ALL_PROXY \
          no_proxy NO_PROXY
    echo -e "\033[33m[✔] 代理已关闭\033[0m"
}

proxy_status() {
    [[ -n "${http_proxy:-}" ]] && echo "代理: $http_proxy" || echo "代理: 未设置"
}
```

### 2. 智能启动脚本（`~/.local/bin/smart-launch`）

```bash
#!/bin/bash
# 智能应用启动器 - 自动应用代理设置

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 获取代理
get_proxy() {
    [[ -n "${all_proxy:-}" ]] && echo "$all_proxy" && return
    [[ -n "${http_proxy:-}" ]] && echo "$http_proxy" && return
    [[ -n "${https_proxy:-}" ]] && echo "$https_proxy" && return
    echo ""
}

# 启动Chrome
launch_chrome() {
    local proxy=$(get_proxy)
    if [[ -n "$proxy" ]]; then
        local host_port="${proxy#*://}"
        if [[ "$proxy" == socks5* ]]; then
            local arg="socks5://$host_port"
        else
            local arg="$host_port"
        fi
        echo -e "${GREEN}启动 Chrome (代理模式)${NC}"
        google-chrome-stable --proxy-server="$arg" "$@" &
    else
        echo -e "${YELLOW}启动 Chrome (无代理)${NC}"
        google-chrome-stable "$@" &
    fi
}

# 启动VSCode
launch_code() {
    local proxy=$(get_proxy)
    if [[ -n "$proxy" ]]; then
        echo -e "${GREEN}启动 VSCode (代理模式)${NC}"
        HTTP_PROXY="$proxy" HTTPS_PROXY="$proxy" \
        ALL_PROXY="$proxy" NO_PROXY="${no_proxy:-localhost,127.0.0.1}" \
        code "$@" &
    else
        echo -e "${YELLOW}启动 VSCode (无代理)${NC}"
        code "$@" &
    fi
}

# 主程序
case "${1:-}" in
    chrome|ch)
        shift; launch_chrome "$@"
        ;;
    code|vs)
        shift; launch_code "$@"
        ;;
    status)
        echo "当前代理:"
        [[ -n "${http_proxy:-}" ]] && echo "  http_proxy: $http_proxy"
        [[ -n "${all_proxy:-}" ]] && echo "  all_proxy: $all_proxy"
        [[ -z "${http_proxy:-}" && -z "${all_proxy:-}" ]] && echo "  未设置"
        ;;
    *)
        echo "用法:"
        echo "  smart-launch chrome    启动Chrome"
        echo "  smart-launch code      启动VSCode"
        echo "  smart-launch status    查看状态"
        ;;
esac

[[ -n "$!" ]] && echo -e "${GREEN}✓ 已启动 (PID: $!)${NC}"
```

### 3. 安装脚本

```bash
# 创建目录并安装
mkdir -p ~/.local/bin
nano ~/.local/bin/smart-launch  # 粘贴上面脚本内容
chmod +x ~/.local/bin/smart-launch

# 添加PATH
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

## 二、使用流程

### 基础使用

```bash
# 1. 开启代理
proxy_on

# 2. 查看状态
smart-launch status

# 3. 启动应用
smart-launch chrome
smart-launch code ~/project

# 4. 关闭代理
proxy_off
```

### 快捷方式

```bash
# 一键工作环境
work() {
    proxy_on
    smart-launch chrome --new-window
    smart-launch code .
}

# 测试代理
test_proxy() {
    proxy_on
    curl -I https://www.google.com
}
```

## 三、故障排除

### 快速诊断

```bash
# 检查环境变量
env | grep -i proxy

# 测试端口
nc -z 127.0.0.1 7890 && echo "HTTP代理端口正常"
nc -z 127.0.0.1 7891 && echo "SOCKS5代理端口正常"

# 检查进程
ps aux | grep mihomo
```

### 常见问题

1. **代理无效**
   ```bash
   # 检查代理客户端
   systemctl --user status mihomo
   # 或
   ps aux | grep mihomo
   ```

2. **脚本无法执行**
   ```bash
   chmod +x ~/.local/bin/smart-launch
   source ~/.bashrc
   ```

3. **Chrome不生效**
   ```bash
   # 查看Chrome启动参数
   ps aux | grep chrome | grep proxy
   ```

## 四、维护命令

```bash
# 更新配置
nano ~/.bashrc        # 修改代理函数
nano ~/.local/bin/smart-launch  # 修改启动脚本

# 重载配置
source ~/.bashrc

# 验证安装
type proxy_on
smart-launch --help
```

**最后更新**: 2026年1月24日  
**系统**: Ubuntu 22.04 Server + GNOME  
**代理**: 本地mihomo (HTTP:7890, SOCKS5:7891)
